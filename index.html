<html style="zoom: 150%;">


<head>
	<title>Corona Stats</title>
	<script src="Chart.bundle.js"> </script>
</head>

<style>
	body {
	  font-family: Arial;
	}

	.overlay {
	  height: 100%;
	  width: 0;
	  position: fixed; /* Stay in place */
	  z-index: 1; /* Sit on top */
	  left: 0;
	  top: 0;
	  background-color: rgb(0,0,0); /* Black fallback color */
	  background-color: rgba(0,0,0, 0.95); /* Black w/opacity */
	  overflow-x: hidden; /* Disable horizontal scroll */
	  transition: 0.5s; /* 0.5 second transition effect to slide in or slide down the overlay (height or width, depending on reveal) */
	}

	div.hide {
		background: #DDDDDD;
		border-radius: 0.5em;
		display: inline-block;
  		padding: 0.5em;
    	margin: 20px;
    	float: right;
	}

	input {
	  border: 1px solid transparent;
	  background-color: #f1f1f1;
	  padding: 10px;
	  font-size: 16px;
	}

	button.add {
	  border: 1px solid transparent;
	  padding: 10px;
	  font-size: 16px;
	  background-color: DodgerBlue;
	  color: #fff;
	  cursor: pointer;
	}

	div.country {
		background: #DDDDDD;
		border-radius: 0.3em;
		display: inline-block;
  		padding: 0.3em;
    	margin: 5px;
	}

	.number {
		text-align: right;
	}
	
</style>

<body>
	<div id="details" class="overlay">
  		<div onclick="hideDetails()" class="hide">×</div>

  		<canvas id="dailyCases" width="40%" height="20%"></canvas>

	</div>

	<div class="autocomplete" style="width:300px;">
		<input id="filterInput" onChange="addFilter()" style="border-radius: 0.3em;" list="filterOptions" placeholder="Country" />
		<datalist id="filterOptions"></datalist>
  		<button class="add" onclick="addFilter()" style="border-radius: 0.3em;">Add</button>
	</div>

	<div id="countryFilter" style="margin-top: 10px;">	</div>

	<div style="margin-top: 10px;">
		<table class="sortable" id="table_summary" width="100%">
			<thead style="text-align: left">
				<tr>
					<th>Country</th>
					<th style="text-align: right;">Total Cases</th>
					<th style="text-align: right;">New Cases</th>
					<th style="text-align: right;">Total Deaths</th>
					<th style="text-align: right;">New Deaths</th>
				</tr>
			</thead>
			<tbody id="summary_content">
			</tbody>
		</table>
	</div>

</body>

<script>
	var filter_countries = ["United States of America", "Germany", "France", "Korea (South)"];

	var allCountries = [];
	var countrySlugs = {};
	var dataDetails = {};

	var request = new XMLHttpRequest();
	var dataSummary;
	request.open('GET', 'https://api.covid19api.com/summary', true);

	request.onload = function () {
		dataSummary = this.response;
		loadCountries();
		updateFilter();
	}
	
	request.send();


	function loadCountries() {
		var allCountryData = JSON.parse(dataSummary).Countries;

		for(var i = 0; i < allCountryData.length; i++) {
		    var obj = allCountryData[i];
		    allCountries.push(obj["Country"]);
		    countrySlugs[obj["Country"]] = obj["Slug"];
		}

		var list = document.getElementById('filterOptions');
		allCountries.forEach(function(item){
		   var option = document.createElement('option');
		   option.value = item;
		   list.appendChild(option);
		});
	}

	function addFilter(){
		var input = document.getElementById('filterInput').value;

		document.getElementById('filterInput').value = '';
		if(!allCountries.includes(input)) return;
		if(filter_countries.includes(input)) return;

		loadDetails(input);
		filter_countries.push(input); 
		updateFilter();
	}

	function updateFilter(){
		document.getElementById('countryFilter').innerHTML = '';

		filter_countries.forEach(function(item, index){
			var div = document.createElement("div");

			div.id = item;
			div.className = 'country';
			div.innerHTML = item + " ×";
			div.addEventListener("click", function(){
				filter_countries.splice(index, 1);
				updateFilter();
			});

			document.getElementById('countryFilter').appendChild(div);

			loadDetails(item);
		})

		loadSummary();
	}

	function loadSummary() {
		var data = JSON.parse(dataSummary);
		var countries = data.Countries;
		
		var table = document.getElementById("summary_content");
		table.innerHTML = '';

		for(var i = 0; i < countries.length; i++) {
		    var obj = countries[i];

			if(!filter_countries.includes(obj["Country"])) continue;

			var row = table.insertRow(-1);

			var country = row.insertCell(0);
			country.innerHTML = obj["Country"];
			country.id = obj["Slug"];
			country.addEventListener("click", function(){ showDetails(this.id) });

			var totalCases = row.insertCell(1);
			totalCases.className = "number";
			totalCases.innerHTML = obj["TotalConfirmed"];

			var newCases = row.insertCell(2);
			newCases.className = "number";
			newCases.innerHTML = obj["NewConfirmed"];

			var totalDeaths = row.insertCell(3);
			totalDeaths.className = "number";
			totalDeaths.innerHTML = obj["TotalDeaths"];

			var newDeaths = row.insertCell(4);
			newDeaths.className = "number";
			newDeaths.innerHTML = obj["NewDeaths"];

		}
		sortTable(document.getElementById("summary_content"), 1);
	}

	function sortTable(table, column) {
		var x, y, shouldSwitch;
		var switching = true;
		while (switching) {
			switching = false;
			var rows = table.rows;
			for (var i = 1; i < (rows.length - 1); i++) {
			  shouldSwitch = false;
			  x = rows[i].getElementsByTagName("TD")[column];
			  y = rows[i + 1].getElementsByTagName("TD")[column];

			  if (parseInt(x.innerHTML) < parseInt(y.innerHTML)) {
			    shouldSwitch = true;
			    break;
			  }
			}
			if (shouldSwitch) {
			  rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
			  switching = true;
			}
		}
	}

	function loadDetails(country){
		if (country in dataDetails) return;

		var request = new XMLHttpRequest();
		var response;
		request.open('GET', 'https://api.covid19api.com/total/dayone/country/' + countrySlugs[country], true);

		request.onload = function () {
			dataDetails[countrySlugs[country]] = this.response;
		}
		
		request.send();
	}

	function showDetails(country){
		var ctx = document.getElementById('dailyCases');
		var newCases = getDailyCases(country);
		var myLineChart = new Chart(ctx, {
		    type: 'line',
		    data: {
			    datasets: [{
					label: 'New Cases',
					data: newCases,
					borderColor: [
						'rgba(255,99,132,1)',
						'rgba(54, 162, 235, 1)',
						'rgba(255, 206, 86, 1)',
						'rgba(75, 192, 192, 1)',
						'rgba(153, 102, 255, 1)',
						'rgba(255, 159, 64, 1)'
					],
		      		borderWidth: 1
				}]
			},
			options: {
				scales: {
					yAxes: [{
			            ticks: {
			                beginAtZero: true
			            }
					}],
					xAxes: [{
						type: 'time',
		                time: {
		                    displayFormats: {
		                        month: 'YY-MM'
		                    }
		                }
					}]
				}
			}
		});

	  	document.getElementById("details").style.width = "100%";
	}

	function getDailyCases(country){
		var dailyCases = [];
		var countryData = JSON.parse(dataDetails[country]);

		for(var i = 0; i < countryData.length; i++) {
			var day = countryData[i];

		    var dayData = {
		    	t : new Date(day["Date"]),
		    	y : day["Active"]
		    }
		    dailyCases.push(dayData);
		}
		return dailyCases;
	}

	function hideDetails() {
	  document.getElementById("details").style.width = "0%";
	}
</script>

</html>
